---
title: Nes hacking build tool
tags:
  - nes
  - asm
abbrlink: 988127664
date: 2013-09-19 16:18:00
---
На основе [конфигов Ti\_](http://homepage.corbina.net/~lich/) научился вставлять в ROM игры ассемблированные кусочки кода.


В качестве базового исходника можно копировать куски реверсированного кода из IDA.

Ассемблер 6502 [Asm6](http://home.comcast.net/~olimar/NES/asm6.zip).

Для сборки надо указать директивой .ORG место, в которое будет вставлен код (относительно адресного пространства процессора). Если собирается не целый банк, то в исходник дополнительно нужно будет скопировать из IDA имена переменных и меток.

После копирования кода рекомендуется собрать его для того, чтобы убедиться, чтобы он бинарно совпадает с кодом из ROM. В случае ошибок, проверить, что с помощью .ORG выставлен правильный адрес (правильный адрес можно проверить, загрузив ром в эмулятор и найти, по какому адресу будет загружен банк с кодом, или просто рассчитать его на основании адреса в роме и данных о маппере игры).

Дальше можно переписывать код, в случае сборки отдельных кусков также надо следить за тем, чтобы не увеличить его размер. 

Собранный бинарник нужно вставить в ром. asm6 для этого не годится, потому что он не умеет отмерять смещения больше FFFF (хотя судя по исходникам вроде должен), но для вставки одного бинарника в другой можно использовать любой другой инструмент, например, ассемблер сеги ASM68K.

Такой подход даёт:

- модульность - разбиваем код и данные на части. удобный контроль версий - текстовые файлы удобно диффить и хранить изменения.
- навешивание тестовых скриптов для проверки целостности результата.
- комментирование кода - без комментариев.

В общем, шаг от программирования в машинных кодах к программированию на языке высокого уровня - ассемблере.

Для теста сделал пару конфигов на основе старых реверсов:
[Выдернутая функция поведения для робота-стража из Чёрного Плаща](https://dl.dropboxusercontent.com/u/852723/hack/dwd_enemies_asm.zip) - теперь не сторожит территорию, а сразу атакует ЧП.
[Список позиций объектов для первого уровня Чипа и Дейла 2](https://dl.dropboxusercontent.com/u/852723/hack/cad2_config.zip) - и измененная версия на основе [хака врагов Roket'а](http://spiiin.livejournal.com/57539.html).

Ну и потом еще переделаю на такой конфиг [lua-скрипт для врагов New Ghostbusters 2.](http://spiiin.livejournal.com/37106.html)