---
title: 'Реверс Duck Tales, Duck Tales 2, Chip and Dale 2 [NES]'
tags:
  - nes
  - hack
abbrlink: 4169606458
date: 2013-04-01 00:56:00
---
**Duck Tales 1.**

Lанные на экран попадают после предварительного размещения по адресам 400-40F, где хранятся в формате набора записей вида (адрес в видеопамяти, сколько байт копировать, байты для копирования).

В более поздних версиях движка эту функцию изменили на простое копирование байт рядами.

Для скроллинга байты копируются парами квадратов 4x4 блока за один шаг, так за 8 шагов составляются 2 новых ряда. Квадраты для следующего шага записываются по адресам 3F0-3F1, 3F4-3F5 - ряды блоков на четном шаге, 3F2-3F3, 3F6-3F7 на нечетном.

Текущий макроблок из 4 блоков перед этим считывается из rom-памяти, мапящейся по адресам BB00, BC00, BD00, BE00.

В BF00 - байт цвета + типа.

С этого момента становится понятно, что алгоритм также совпадает с уже разобранным, чип-и-дейловским, но со смещением проекции макроблока на 256 байт вперёд.

Следуюшим шагом должно было бы быть вычисление индекса макротайла, но оно вычисляется сложным рассчетом адресов и битовой магией, в которой участвует непонятный набор адресов, который складывается из смеси позиции бурундука на экране, относительной позиции относительно экрана начала и нескольких констант.

В чипе-и-дейле я не смог дизассемблировать её и написал построчный эмулятор на питоне, через который прогнал все возможные значения из дампа. Но он работал с ошибкой, из-за которой корректно показывались только четные ряды. Повторять такой не хотелось, поэтому я просто воспользовался тем, что разности адресов совпадали во всех играх и получил адрес проекции макроблоков 0xB6E0 + 0x100 = 0xB7E0

Базовый адрес раскладки уровня лежит по смещению, записанному в $20-$21 (в C&D был в $32-$33), код алгоритма полностью такой же, изменились только адреса.

Загружая разные уровни, можно посмотреть все наборы раскладок (CE6B/CEA3/CEE3/CF13/CF43 - размеры всех уровней одинаковы). Указатели на раскладки хранятся в разобранным на старший и младший байт виде, найдя их в ROM, можно определить смещение записи об уровне - 0x1CF90, и рядом со смещениями считать оставшуюся необходимую информацию для загрузки.

Хронологически Duck Tales - первая из серии диснеевских игр, движок которой потом оптимизировали для Chip'n'Dale, перенесли базовые адреса (которые остались и в Черном Плаще), расширили возможные раскладки уровня, добавили гибкие настройки способов скроллинга и переключение параметров после входа в двери.

**Duck Tales 2.**
Скроллинг экрана делается построчно, данные для него собираются в 56E-57E.
Данные выбираются по смещению от поинтеров, предварительно записанных по адресам 00-01 и 02-03 (для первого уровня смещения 807A/827A).
Индекс смещения означает номер блока.

Индекс сохраняется в регистр X, а берётся из строки байт с началом в 3A и индексом в Y. 

В 0x3A данные попадают из ячейки с адресом, записанным в(0E-0F). Это - указатель на данные о блоках текущего экрана.

После записи индекса макроблока в ряд 3A-3F вызывается функция инплейсной трансформации номера макроблока в индексы составляющих его блоков.

Индексы блоков записываются в 4 поинтера (4D-4E), (4F-50),(51-52) и (53-54). 

Данные об адресе раскладки уровня записаны в (4B-4C), а номер в этой раскладке кодируется байтами B и D (индекс = B*8 + D). 

Данные в B и D попадают изначально из ячеек 97 и 98 через ячейки 18 и 1B. 97 и 98 - стартовые координаты экранов скруджа в начале уровня, берутся из ROM, спроецированного в адресное пространство AE0B - AE0E.

Данные о раскладке попадают в 4B на старте уровня. Адрес считавания записан в (00-01). Считываются 20 байт - 2 смещение начала, дальше следом в (4В-54) 4 поинтера на макротайлы и следом в (55-5E) 5 поинтеров на тайлы (4 кусочка и 5-й на байты цвета, тип кажется где-то в другом месте кодируется).

Скроллы тоже где-то отдельно лежат, если они вообще используются и нужны. 

Пример раскладки 1 уровня, начало в 0F (9C2A): 
```
00 01 02 03 00 00 00 00 00 04 00 05 06 06 07 08 00 09 0A 0B 0C 0D 00 0E 0F 10 11 12 13 14 00 14 00 15 16 17 18 19 1A 1B 00 00 00 00 1C 1D 1E 1F
```

Остальные раскладки лежат по смещениям (9C2A/9C5A/9C8A/9CBA/9CEA/901A/9C5A)

Вторые Duck Tales вышли в 1993, после ЧП и Чипа и Дейла, движок допилен окончательно. Отточено сжатие экранов - если видно только левую часть, то правая половинка используется где-то в другом месте.

Раскладки уровня заполнены практически полностью, так, чтобы было несколько проходов и множество секретных комнат.

Код написан просто и понятно, оперативная память распределяется грамотно, похожие значение лежат рядом.

Единственная странность - переход от макротайлов к тайлам сделан через указатели, и их смещение неравномерные - разница между блоками не 256 байт, а переменная, из-за этого труднее запихнуть это в редактор.

Скорее всего между записями о макроблоках лежит еще какая-то дополнительная информация об уровне.

**Chip and Dale 2.**

Раскопки начал не с нуля, а с картинки об устройстве уровня Roket'а :
[картинка](http://ic.pics.livejournal.com/spiiin/20318251/24611/24611_original.png)

Что сразу навело на нехорошие мысли о чём-то заумном :(
    
Данные в видеопамять попадают через строку 53B, куда они копируются из 5D1-5EF - странное дублирование.

Скроллинг делается в два ряда, но из маленьких тайлов, а не больших.

С какой-то целью было принято решение отказаться от макроблоков и строить уровни просто из блоков 2x2.

Из-за этого описания уровня весит в 4 раза больше, и чтобы обойти ограничение размера, в уровне где-то две трети экранов повторяющиеся (хотя очень грамотно перемешаны так, что обычный игрок об этом навряд ли догадается).

Начала блоков записаны 00-01 и 02-03, стандартно это 8000 и 8200.

Номера блоков записаны в 52A (ряд из 14 штук). Где-то рядом с ними должны миксоваться байты цвета и типа. 

Адрес описания экрана тоже записан через указатели %). Записан в (0E), адреса в ром - 0x10, 0x110 + X 6. X считывается из (7B), где можно прочитать адрес раскладки уровня - 9E6A, 9EAA, 9EEA, 9FAA, 9F6A и т.д.

Адрес начала в расладке берется из содержимого 0C, деленного пополам, а туда попадает через B1 и B3, где хранятся X и Y координаты экрана. 

Загрузка начальных значений B1 и B3 при загрузке уровня или входе в дверь.

Данные о начальных значениях:
```
B9B5 - уровень 1-1
B9CE - уровень 1-2
B9E7 - уровень 1-3
BA00 - бонус
BDB6 - диалог с боссом
BA19 - босс 1.
```

Вторые C&D вышли в том же году, что и DT2, но движок решили кардинально поменять, выкинули систему макроблоков и сделали уровни из повторяющихся экранов. Обращение к любым данным сделано через указатели или указатели на указатели, что мешает разбору. Архитектурно первая часть игры намного ближе к другим диснеевским аркадам от Capcom, чем ко второй части.